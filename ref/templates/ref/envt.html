{% extends "base.html" %}
{% load filter %}
{% load staticfiles %}
{% block pagetitle %}{{envt.name}}{% endblock %}
{% block maintitle %}Environnement {{envt.name}}{% endblock %}

{% block frequentActionsButtons %}
{% if perms.ref.scm_addenvironment %}<a href="{% url 'ref:envt_duplicate' envt.name %}" title="Dupliquer l'environnement">D</a>{% endif %}
<a href="{% url 'ref:instance_envt' envt.id %}" title="Editer l'environnement">E</a>
<a href="{% url 'admin:ref_environment_change' envt.id %}" title="Paramètres de l'environnement">P</a>
{% endblock %}

{% block scripts %}
<script type="text/javascript" src='{% static "d3.min.js" %}'></script>
<script type="text/javascript" src='{% static "dagre-d3.min.js" %}'></script>
<script type="text/javascript" src='{% static "jquery-1.9.1.js" %}'></script>
{% endblock scripts %}

{% block content %}
{% regroup envt.component_instances.all|dictsort:"description.tag"|dictsort:"description.name" by description.description as compotype_list %}

<div class='row'>
	<div class='col-md-2'>
		<div class='t2'>Généralités</div>
		<div class="metContainer metFreeRect defaultHighlightBackground" style="min-width: 100%;">
			<table>
				<tr><td>Code</td><td>: {{envt.name}}</td></tr>
				<tr><td>Responsable</td><td>: {{envt.manager}}</td></tr>
				<tr><td>Référencé le</td><td>: {{envt.buildDate|date:'d/m/y'}}</td></tr>
				<tr><td>Détruit le</td><td>: {% if envt.destructionDate %}{{envt.destructionDate}}{% else %}à plannifier{% endif %}</td></tr>
				<tr><td>Catégorie</td><td>: {{envt.typology.name}}</td></tr>
				<tr><td>Géré en version</td><td>: {% if envt.managed %}oui{% else %}non{% endif %}</td></tr>
		</table>	
		</div><br/><br/>
		<div class='t2'>Liens GCL</div>
		<a  href="{% url 'scm:envtinstallhist' envt.name %}" class='metRectList defaultHighlightBackground' style='width:100%; color: white;'>
			<img src='{% static "history.svg" %}' style="width:40px;height:40px;position:absolute; z-index: 0; right: 7px; top: -1px;"><div style='z-index: 2; position: absolute; color: black;'>Historique des installations</div>
		</a>
		<a  href="{% url 'scm:backup_list' %}" class='metRectList defaultHighlightBackground' style='width:100%; color: white;'>
			<img src='{% static "backup.svg" %}' style="width:40px;height:40px;position:absolute; z-index: 0; right: 7px; top: -1px;"><div style='z-index: 2; position: absolute; color: black;'>Sauvegardes disponibles</div>
		</a>
		<a  href="{% url 'scm:tag_list' %}" class='metRectList defaultHighlightBackground' style='width:100%; color: white;'>
			<img src='{% static "tag.svg" %}' style="width:40px;height:40px;position:absolute; z-index: 0; right: 7px; top: 0px;"><div style='z-index: 2; position: absolute; color: black;'>Tags</div>
		</a>
	</div>
	
	<div class='col-md-8'>
		<div class='t2'>Composants</div>	
		{% for compotype in compotype_list %}
			<div class='t4'>{{compotype.grouper}}</div>
			<div class='table-responsive'>
			<table class='table table-condensed table-bordered table-hover'>
			{% for compo in compotype.list %}

				{% if forloop.first %}
					<tr><th>Composant</th><th>Nom</th>
					{% if compo.description %}
						{% comment %} Title row {% endcomment %} 
						{% for field in compo.field_set.all|dictsort:"field.widget_row" %}
							{% if field.field.widget_row >= 0 %}
								{% if not field.field.sensitive or perms.ref.allfields_componentinstance or not envt.protected %}
									<th>{{field.field.short_label|capfirst}}</th>
								{% endif %}
							{% endif %}
						{% endfor %}
						
						{% comment %} Data rows {% endcomment %}
						{% for field in compo.description.computed_field_set.all|dictsort:"widget_row" %}
							{% if field.widget_row >= 0 %}
								{% if not field.sensitive or perms.ref.allfields_componentinstance or not envt.protected %}
									<th>{{field.short_label|capfirst}}</th>
								{% endif %}
							{% endif %}
						{% endfor %}
					{% endif %}
					{% if perms.ref.change_component_instance %}<th></th>{% endif %}
					</tr>
				{% endif %}
			
				{% if not compo.deleted %}
					<tr>
						<td>
						{% if compo.instanciates %}
							{{compo.instanciates.implements.application.name}} - {{compo.instanciates.implements.name}}
						{% endif %}
						</td>
						<td>
						{{ compo.name | capfirst }}
						</td>
						
						{% if compo.description and not compo.deleted %}
							{% for field in compo.field_set.all|dictsort:"field.widget_row" %}
								{% if field.field.widget_row >= 0 %}
									{% if not field.field.sensitive or perms.ref.allfields_componentinstance or not envt.protected %}
										<td>{{field.value}}</td>
									{% endif %}
								{% endif %}
							{% endfor %}
							{% for field in compo.description.computed_field_set.all|dictsort:"widget_row" %}
								{% if field.widget_row >= 0 %}
									{% if not field.sensitive or perms.ref.allfields_componentinstance or not envt.protected %}
										<td>{{compo | apply_field_template:field | safe}}</td>
									{% endif %}
								{% endif %}
							{% endfor %}
						{% endif %}
						{% if perms.ref.change_component_instance %}<td><a href='{%url "ref:edit_ci" compo.pk %}'>éditer</a></td>{% endif %}
					</tr>	
				{% endif%}
			{% endfor %}
			</table>
			</div>
		{% endfor %}
	</div>
	
	
	<div class='col-md-2'>
		<div class='t2'>Représentation</div>
		<script type="text/javascript">
$(document).ready(function()
{	
	$.ajax(
			{
				url : '{% url "ref:cartosimpledata" envt.ci_id_list "4" "3" %}',
				type : "GET",
				dataType : "json",
			}).done(function(json)
			{
				var digraph = dagreD3.json.decode(json['nodes'], json['edges']);
				
				var renderer = new dagreD3.Renderer();
				renderer.run(digraph, d3.select("svg g"));
			});
});
</script>
		<svg width='2048' height='2048'>
		    <g transform="translate(20,20) scale(0.7)"/>
		</svg>
	</div>
</div>
{% endblock content %}

