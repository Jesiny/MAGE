{% extends "base.html" %}
{% load filter %}
{% block pagetitle %}{{envt.name}}{% endblock %}
{% block maintitle %}Environnement {{envt.name}}{% endblock %}

{% block frequentActionsButtons %}
{% if perms.ref.scm_addenvironment %}<a href="{% url 'ref:envt_duplicate' envt.name %}" title="Dupliquer l'environnement">D</a>{% endif %}
<a href="{% url 'ref:instance_envt' envt.id %}" title="Editer l'environnement">E</a>
{% endblock %}

{%block navigationButtons%}
<a href="{% url 'ref:envts' %}" title="Liste des environnements">↑</a>
{%endblock%}

{% block content %}
{% regroup envt.component_instances.all|dictsort:"implementation" by implementation.description as compotype_list %}

<div class='row'>
	<div class='col-md-2'>
		<div class='t2'>Généralités</div>
		<div class="metContainer metFreeRect defaultHighlightBackground">
			<table>
				<tr><td>Nom de code</td><td>: {{envt.name}}</td></tr>
				<tr><td>Responsable</td><td>: {{envt.manager}}</td></tr>
				<tr><td>Référencé le</td><td>: {{envt.buildDate}}</td></tr>
				<tr><td>Sera détruit le</td><td>: {{envt.destructionDate}}</td></tr>
				<tr><td>Catégorie</td><td>: {{envt.typology.name}}</td></tr>
		</table>	
		</div><br/><br/>
		<a  href="{% url 'scm:envtinstallhist' envt.name %}">Historique des installations</a><br/>
		<a href="{% url 'scm:backup_list' %}">Sauvegardes</a><br/>
		<a href="{% url 'scm:tag_list' %}">Tags</a><br/>
	</div>
	
	<div class='col-md-8'>
		<div class='t2'>Composants</div>	
		{% for compotype in compotype_list %}
			<div class='t4'>{{compotype.grouper}}</div>
			<table class='visibleTable'>
			{% for compo in compotype.list %}

				{% if forloop.first %}
					<tr><th></th><th>name</th>
					{% if compo.implementation %}
						{% for field in compo.field_set.all|dictsort:"field.widget_row" %}
							{% if field.field.widget_row >= 0 %}
								{% if not field.field.sensitive or perms.ref.allfields_componentinstance or not envt.protected %}
									<th>{{field.field.short_label}}</th>
								{% endif %}
							{% endif %}
						{% endfor %}
						{% for field in compo.implementation.computed_field_set.all|dictsort:"widget_row" %}
							{% if field.widget_row >= 0 %}
								{% if not field.sensitive or perms.ref.allfields_componentinstance or not envt.protected %}
									<th>{{field.short_label}}</th>
								{% endif %}
							{% endif %}
						{% endfor %}
					{% endif %}
					</tr>
				{% endif %}
			
				{% if not compo.deleted %}
					<tr>
						<td>
						{% if compo.instanciates %}
							{{compo.instanciates.implements.application.name}} - {{compo.instanciates.implements.name}}
						{% endif %}
						</td>
						<td>
						{{ compo.name | capfirst }}
						</td>
						
						{% if compo.implementation %}
							{% for field in compo.field_set.all|dictsort:"field.widget_row" %}
								{% if field.field.widget_row >= 0 %}
									{% if not field.field.sensitive or perms.ref.allfields_componentinstance or not envt.protected %}
										<td>{{field.value}}</td>
									{% endif %}
								{% endif %}
							{% endfor %}
							{% for field in compo.implementation.computed_field_set.all|dictsort:"widget_row" %}
								{% if field.widget_row >= 0 %}
									{% if not field.sensitive or perms.ref.allfields_componentinstance or not envt.protected %}
										<td>{{compo | apply_field_template:field}}</td>
									{% endif %}
								{% endif %}
							{% endfor %}
						{% endif %}
					</tr>	
				{% endif%}
			{% endfor %}
			</table>
		{% endfor %}
	</div>
	
	
	<div class='col-md-2' style='width=auto;'>
		<div class='t2'>Représentation</div>
		<img src="{% url 'ref:grenvt' envt.id %}" alt="environment picture"> 
	</div>
</div>
{% endblock content %}

